import { Tabs, Tab } from '../../components/tabs'

# Edge Runtime Jest Environment

The **@edge-runtime/jest-environment** package enables you to run [Jest](https://jestjs.io) tests against the Edge Runtime environment.

It helps you to write tests assertion without being worried about the environment setup.

## Installation

<Tabs items={['npm', 'yarn', 'pnpm']} storageKey='selected-pkg-manager'>
  <Tab>```sh npm install @edge-runtime/jest-environment --save ```</Tab>
  <Tab>```sh yarn add @edge-runtime/jest-environment ```</Tab>
  <Tab>```sh pnpm install @edge-runtime/jest-environment --save ```</Tab>
</Tabs>

## Usage

Jest enables you to define the test environment through a [code comment](https://jestjs.io/docs/configuration#testenvironment-string) or as a [CLI option](https://jestjs.io/docs/cli#--envenvironment).

For example, the following test would **pass**:

```js
// jest --env node
// ✅ Pass
it('should return the correct value', () => {
  let val = eval('2 + 2')
  expect(val).toBe(4)
})
```

The following test would **fail** when using the Edge Runtime:

```js
// jest --env @edge-runtime/jest-environment
// ❌ Fail
// Error name:    "EvalError"
// Error message: "Code generation from strings disallowed for this context"
it('should return the correct value', () => {
  let val = eval('2 + 2')
  expect(val).toBe(4)
})
```

## Extend expect

The **@edge-runtime/jest-environment** package comes with a sub-module that contains useful [Jest matchers](https://jestjs.io/docs/expect#expectextendmatchers) to test `Request` and `Response`.

### Usage

Add the following in your `jest.config.js` file:

```js
// See https://jestjs.io/docs/configuration#setupfilesafterenv-array
setupFilesAfterEnv: ['@edge-runtime/jest-environment/extend'],
```

To include the TypeScript types, add the following in your `tsconfig.json` file:

```json
// See https://www.typescriptlang.org/tsconfig#include
"include": [
  "node_modules/@edge-runtime/jest-environment/extend.d.ts"
]
```

### API

#### .toHaveStatus

It checks for HTTP status code or message correctness:

```js
const response = new Response('OK')

expect(response).toHaveStatus(200)
expect(response).toHaveStatus('Successful')
expect(response).not.toHaveStatus(201)
```

#### .toHaveJSONBody

It checks HTTP response body is a JSON:

```js
const response = Response.json({ hello: 'world' })

expect(response).toHaveJSONBody({ hello: 'world' })
expect(response).not.toHaveJSONBody({ foo: 'baz' })
```

#### .toHaveTextBody

It checks HTTP response body is a text:

```js
const response = Response('hello world')

expect(response).toHaveTextBody('hello world')
expect(response).not.toHaveTextBody('foo bar')
```
